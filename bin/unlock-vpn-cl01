#!/usr/bin/env bash
#
# ipset must exists:
#
#   firewall-cmd --permanent --new-ipset=acces-vpn --type=hash:ip
#   firewall-cmd --permanent --zone=trusted --add-source=ipset:acces-vpn
#   firewall-cmd --reload
#
# Package needed for ifdata tool:
#   sudo dnf install -y moreutils
#

nodes=("n01.cl01" "n02.cl01" "n03.cl01" "n04.cl01" "n05.cl01")
myip=$(ifdata -pa vpn0)

echo "*** My vpn0 IP is: $myip"

for node in "${nodes[@]}"
do
    echo "** Processing node $node..."

    # Reset current entries
    echo "* Reset current ipset acces-vpn..."
    ssh -t root@$node "firewall-cmd --permanent --delete-ipset=acces-vpn"
    ssh -t root@$node "firewall-cmd --permanent --new-ipset=acces-vpn --type=hash:ip && firewall-cmd --permanent --zone=trusted --add-source=ipset:acces-vpn"
    
    # Add new entries
    echo "* Add $myip to ipset..."
    ssh -t root@$node "firewall-cmd --permanent --ipset=acces-vpn --add-entry=$myip && firewall-cmd --reload"
done

